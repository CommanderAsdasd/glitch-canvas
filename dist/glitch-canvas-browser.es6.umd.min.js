!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.glitch=e()}(this,function(){"use strict";function t(t){function e(){return t}function a(){var t=l({},j);return M||l(t,L),t}function n(){var t=l({},j);return E||l(t,B),t}function i(t){return t}function o(t){return p(s,t)}function u(t){return p(i,t)}function c(t){return b(i)}function f(t){return b(h,t,!0)}function d(t){return b(g,t,!0)}function p(t,e,a){return M=function(){return new Promise(function(n,r){if(a)t(e,n,r);else if(t===i)n(e);else try{n(t(e,n,r))}catch(t){r(t)}})},w()?v():n()}function b(t,e,n){return E=function(a){return new Promise(function(r,s){n?t(a,e,r,s):t===i?r(a):t(a,e).then(r,s)})},w()?v():a()}function w(){return M&&E}function v(){return new Promise(function(e,a){M().then(function(e){return y(e,t)},a).then(function(t){E(t).then(e,a)},a)})}function y(t,e){return new Promise(function(a,n){m(t,e.quality).then(function(a){return D(t,a,e)},n).then(a,n)})}function D(t,e,a){return new Promise(function(n,r){I.addEventListener("message",function(t){t.data&&t.data.base64URL?n(t.data.base64URL):r(t.data&&t.data.err?t.data.err:t)}),I.postMessage({params:a,base64URL:e,imageData:t,imageDataWidth:t.width,imageDataHeight:t.height})})}t=r(t);let M,E,I=new Worker(URL.createObjectURL(new Blob(['function fail(a){self.postMessage({err:a.message||a})}function success(a){self.postMessage({base64URL:a})}var isImageData=function(a){return a&&"number"==typeof a.width&&"number"==typeof a.height&&a.data&&"number"==typeof a.data.length&&"object"==typeof a.data};const base64Chars="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/",base64Map=base64Chars.split(""),reversedBase64Map$1={};base64Map.forEach(function(a,e){reversedBase64Map$1[a]=e});var maps={base64Map:base64Map,reversedBase64Map:reversedBase64Map$1};const reversedBase64Map=maps.reversedBase64Map;var base64ToByteArray=function(a){for(var e,s,t=[],r=23,i=a.length;r<i;r++){switch(e=reversedBase64Map[a.charAt(r)],(r-23)%4){case 1:t.push(s<<2|e>>4);break;case 2:t.push((15&s)<<4|e>>2);break;case 3:t.push((3&s)<<6|e)}s=e}return t},jpgHeaderLength=function(a){for(var e=417,s=0,t=a.length;s<t;s++)if(255===a[s]&&218===a[s+1]){e=s+2;break}return e},glitchByteArray=function(a,e,s,t){let r=jpgHeaderLength(a),i=a.length-r-4,n=s/100,p=e/100;for(var h=0;h<t;h++){let e=i/t*h|0,s=i/t*(h+1)|0,o=s-e,g=e+o*p|0;g>i&&(g=i);let c=~~(r+g);a[c]=~~(256*n)}return a};const base64Map$1=maps.base64Map;var byteArrayToBase64=function(a){let e,s,t,r=["data:image/jpeg;base64,"];for(var i=0,n=a.length;i<n;i++){switch(s=a[i],e=i%3){case 0:r.push(base64Map$1[s>>2]);break;case 1:r.push(base64Map$1[(3&t)<<4|s>>4]);break;case 2:r.push(base64Map$1[(15&t)<<2|s>>6]),r.push(base64Map$1[63&s])}t=s}return 0===e?(r.push(base64Map$1[(3&t)<<4]),r.push("==")):1===e&&(r.push(base64Map$1[(15&t)<<2]),r.push("=")),r.join("")},glitchImageData=function(a,e,s){if(isImageData(a)){let a=base64ToByteArray(e),t=glitchByteArray(a,s.seed,s.amount,s.iterations),r=byteArrayToBase64(t);return r}throw new Error("glitchImageData: imageData seems to be corrupt.")};onmessage=function(a){const e=a.data.imageData,s=a.data.params,t=a.data.base64URL;if(e&&t&&s)try{void 0===e.width&&"number"==typeof a.data.imageDataWidth&&(e.width=a.data.imageDataWidth),void 0===e.height&&"number"==typeof a.data.imageDataHeight&&(e.height=a.data.imageDataHeight);const r=glitchImageData(e,t,s);success(r)}catch(a){fail(a)}else fail(a.data.imageData?"Parameters are missing.":"ImageData is missing.");self.close()};'],{type:"text/javascript"}))),j={getParams:e,getInput:a,getOutput:n},L={fromImageData:u,fromImage:o},B={toImage:f,toDataURL:c,toImageData:d};return a()}var e=function(t,e,a){return t<e?e:t>a?a:t},a=function(t){let e=!1;if(void 0!==t)try{e=JSON.parse(JSON.stringify(t))}catch(t){}return e},n={amount:35,iterations:20,quality:30,seed:25},r=function(t){return"object"!=typeof(t=a(t))&&(t={}),Object.keys(n).filter(function(t){return"iterations"!==t}).forEach(function(a){"number"!=typeof t[a]||isNaN(t[a])?t[a]=n[a]:t[a]=e(t[a],0,100),t[a]=Math.round(t[a])}),("number"!=typeof t.iterations||isNaN(t.iterations)||t.iterations<=0)&&(t.iterations=n.iterations),t.iterations=Math.round(t.iterations),t};class i{constructor(t=300,e=150){this.canvasEl=document.createElement("canvas"),this.canvasEl.width=t,this.canvasEl.height=e,this.ctx=this.canvasEl.getContext("2d")}getContext(){return this.ctx}toDataURL(t,e,a){if("function"!=typeof a)return this.canvasEl.toDataURL(t,e);a(this.canvasEl.toDataURL(t,e))}get width(){return this.canvasEl.width}set width(t){this.canvasEl.width=t}get height(){return this.canvasEl.height}set height(t){this.canvasEl.height=t}}i.Image=Image;var s=function(t){if(t instanceof HTMLImageElement){if(!t.naturalWidth||!t.naturalHeight||!1===t.complete)throw new Error("This this image hasn't finished loading: "+t.src);const e=new i(t.naturalWidth,t.naturalHeight),a=e.getContext("2d");a.drawImage(t,0,0,e.width,e.height);const n=a.getImageData(0,0,e.width,e.height);return n.data&&n.data.length&&(void 0===n.width&&(n.width=t.naturalWidth),void 0===n.height&&(n.height=t.naturalHeight)),n}throw new Error("This object does not seem to be an image.")};const o=i.Image;var u=function(t){return new Promise(function(e,a){let n=new o;n.onload=function(){e(n)},n.onerror=function(t){a(t)},n.src=t})},h=function(t,e,a,n){u(t).then(a,n)},c=function(t){return{width:t.width||t.naturalWidth,height:t.height||t.naturalHeight}},f=function(t){let e=c(t),a=new i(e.width,e.height),n=a.getContext("2d");return n.drawImage(t,0,0,e.width,e.height),{canvas:a,ctx:n}},g=function(t,e,a,n){u(t).then(function(t){let e=c(t),n=f(t).ctx.getImageData(0,0,e.width,e.height);n.width||(n.width=e.width),n.height||(n.height=e.height),a(n)},n)},d=function(t){return t&&"number"==typeof t.width&&"number"==typeof t.height&&t.data&&"number"==typeof t.data.length&&"object"==typeof t.data},m=function(t,e){return new Promise(function(a,n){if(d(t)){const n=new i(t.width,t.height),r=n.getContext("2d");r.putImageData(t,0,0);const s=n.toDataURL("image/jpeg",e/100);a(s)}else n(new Error("object is not valid imageData"))})};const p={};"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/".split("").forEach(function(t,e){p[t]=e});var l=Object.assign;return t});